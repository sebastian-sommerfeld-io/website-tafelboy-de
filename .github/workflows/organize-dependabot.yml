---
name: "Organize: Dependabot Pull Requests"

# +-------------------------------------------+
# |                                           |
# |    DO NOT EDIT DIRECTLY !!!!!             |
# |                                           |
# |    File is generated by jarvis.           |
# |    Update file in the jarvis module so    |
# |    you can apply changes to all repos.    |
# |                                           |
# +-------------------------------------------+

on:
  schedule:
    - cron: '0 12 * * *' # https://crontab.guru

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  assign-user:
    name: Assign PRs with label 'dependencies'
    runs-on: ubuntu-latest
    steps:
      - name: Get PR and assign user (filtered by github cli)
        id: vars
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN_REPO_AND_PROJECT }}
          label: dependencies
          assignee: ${{ github.actor }}
        run: |
          pr_ids="$(gh pr list --repo "$GITHUB_REPOSITORY" --label "$label" --json number --jq '.[].number')"
          for id in $pr_ids; do
            gh pr edit "$id" --repo "$GITHUB_REPOSITORY" --add-assignee "$assignee"
          done

  send-notification:
    runs-on: ubuntu-latest
    needs: ['assign-user']
    steps:
      - name: Send Pull Request information to Google Chat
        uses: Co-qn/google-chat-notification@releases/v1
        with:
          name: New Pull Request(s) with label 'dependencies'
          url: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
          status: ${{ job.status }}

  on-failure:
    runs-on: ubuntu-latest
    needs: ['assign-user', 'send-notification']
    if: failure()
    steps:
      - name: Send Pipeline Status to Google Chat
        if: always()
        uses: Co-qn/google-chat-notification@releases/v1
        with:
          name: ${{ github.workflow }}
          url: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
          status: failure
